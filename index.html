<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D&D: Morgland</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body onload="loadFromLocalStorage()">

<header>
  <div class="avatar-preview" id="avatarPreview" role="img" aria-label="Персонаж"></div>
  <label for="avatarInput" class="sr-only">Загрузить аватар</label>
  <input type="file" id="avatarInput" accept="image/*">
  <h1 contenteditable="true" id="charName" oninput="limitContentLength('charName', 50); saveToLocalStorage()">Mell</h1>
  <div class="sub">
    Раса: <span contenteditable="true" id="charRace" oninput="limitContentLength('charRace', 30); saveToLocalStorage()">Tiefling</span> |
    Класс: <span contenteditable="true" id="charClass" oninput="limitContentLength('charClass', 30); saveToLocalStorage()">Ranger</span> |
    Уровень: <span contenteditable="true" id="charLevel" oninput="limitContentLength('charLevel', 3); saveToLocalStorage()">1</span>
  </div>
</header>

<div class="tab active-tab" id="tabCharacter">
  <div class="container">
    <h2>Характеристики</h2>
    <div class="stats">
      <label>Текущее HP: <input type="number" min="0" max="999" id="currentHP" value="10" oninput="validateHP(); saveToLocalStorage()"></label>
      <label>Макс. HP: <input type="number" min="0" max="999" id="maxHP" value="10" oninput="validateHP(); saveToLocalStorage()"></label>
      <label>AC: <input type="number" min="0" max="50" id="ac" value="15" readonly></label>
      <label>Proficiency Bonus: <input type="number" min="2" max="6" id="profBonus" value="2" readonly></label>
    </div>
    <h2>Опыт</h2>
    <div class="xp">
      <label for="xpCurrent">Текущий XP</label>
      <input type="number" min="0" id="xpCurrent" value="0" oninput="updateXP(); saveToLocalStorage()">
      <label for="xpNext">XP до следующего уровня</label>
      <input type="number" min="0" id="xpNext" value="300" readonly>
      <div class="progress-bar">
        <div class="progress-fill" id="xpProgress" style="width:0%"></div>
      </div>
      <button onclick="addXP()">Добавить XP</button>
      <button onclick="levelUp()">Повысить уровень</button>
    </div>
    <h2>Способности</h2>
    <div class="abilities" id="abilitiesContainer">
      <div class="ability-card">
        <label for="str">Сила</label>
        <input type="number" min="1" max="30" value="8" id="str" oninput="updateModifier('str'); updateSkills(); updateAC(); saveToLocalStorage()">
        <span id="strMod">Mod: -1</span>
      </div>
      <div class="ability-card">
        <label for="dex">Ловкость</label>
        <input type="number" min="1" max="30" value="14" id="dex" oninput="updateModifier('dex'); updateSkills(); updateAC(); saveToLocalStorage()">
        <span id="dexMod">Mod: +2</span>
      </div>
      <div class="ability-card">
        <label for="con">Телосложение</label>
        <input type="number" min="1" max="30" value="12" id="con" oninput="updateModifier('con'); updateSkills(); saveToLocalStorage()">
        <span id="conMod">Mod: +1</span>
      </div>
      <div class="ability-card">
        <label for="int">Интеллект</label>
        <input type="number" min="1" max="30" value="11" id="int" oninput="updateModifier('int'); updateSkills(); saveToLocalStorage()">
        <span id="intMod">Mod: +0</span>
      </div>
      <div class="ability-card">
        <label for="wis">Мудрость</label>
        <input type="number" min="1" max="30" value="13" id="wis" oninput="updateModifier('wis'); updateSkills(); saveToLocalStorage()">
        <span id="wisMod">Mod: +1</span>
      </div>
      <div class="ability-card">
        <label for="cha">Харизма</label>
        <input type="number" min="1" max="30" value="16" id="cha" oninput="updateModifier('cha'); updateSkills(); saveToLocalStorage()">
        <span id="chaMod">Mod: +3</span>
      </div>
    </div>
    <h2>Броски кубиков</h2>
    <select id="diceAbility">
      <option value="none">Без модификатора</option>
      <option value="str">Проверка Силы</option>
      <option value="dex">Проверка Ловкости</option>
      <option value="con">Проверка Телосложения</option>
      <option value="int">Проверка Интеллекта</option>
      <option value="wis">Проверка Мудрости</option>
      <option value="cha">Проверка Харизмы</option>
      <option value="athletics">Атлетика</option>
      <option value="acrobatics">Акробатика</option>
      <option value="sleightOfHand">Ловкость рук</option>
      <option value="stealth">Скрытность</option>
      <option value="arcana">Магия</option>
      <option value="history">История</option>
      <option value="investigation">Расследование</option>
      <option value="nature">Природа</option>
      <option value="religion">Религия</option>
      <option value="animalHandling">Обращение с животными</option>
      <option value="insight">Проницательность</option>
      <option value="medicine">Медицина</option>
      <option value="perception">Восприятие</option>
      <option value="survival">Выживание</option>
      <option value="deception">Обман</option>
      <option value="intimidation">Запугивание</option>
      <option value="performance">Выступление</option>
      <option value="persuasion">Убеждение</option>
    </select>
    <div class="dice-row">
      <button class="dice-button" data-dice="4">D4</button>
      <button class="dice-button" data-dice="6">D6</button>
      <button class="dice-button" data-dice="8">D8</button>
      <button class="dice-button" data-dice="10">D10</button>
      <button class="dice-button" data-dice="12">D12</button>
      <button class="dice-button" data-dice="20">D20</button>
      <button class="dice-button" data-dice="100">D100</button>
    </div>
    <div id="diceResult" style="margin-top:12px;text-align:center;font-size:16pt;white-space:pre-wrap;"></div>
  </div>
</div>

<div class="tab" id="tabSkills">
  <div class="container">
    <h2>Навыки</h2>
    <div class="skills" id="skillsContainer">
      <div class="skill-item">
        <input type="checkbox" id="athleticsProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="athleticsProf">Атлетика (Сила)</label>
        <span id="athleticsBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="acrobaticsProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="acrobaticsProf">Акробатика (Ловкость)</label>
        <span id="acrobaticsBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="sleightOfHandProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="sleightOfHandProf">Ловкость рук (Ловкость)</label>
        <span id="sleightOfHandBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="stealthProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="stealthProf">Скрытность (Ловкость)</label>
        <span id="stealthBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="arcanaProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="arcanaProf">Магия (Интеллект)</label>
        <span id="arcanaBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="historyProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="historyProf">История (Интеллект)</label>
        <span id="historyBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="investigationProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="investigationProf">Расследование (Интеллект)</label>
        <span id="investigationBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="natureProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="natureProf">Природа (Интеллект)</label>
        <span id="natureBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="religionProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="religionProf">Религия (Интеллект)</label>
        <span id="religionBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="animalHandlingProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="animalHandlingProf">Обращение с животными (Мудрость)</label>
        <span id="animalHandlingBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="insightProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="insightProf">Проницательность (Мудрость)</label>
        <span id="insightBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="medicineProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="medicineProf">Медицина (Мудрость)</label>
        <span id="medicineBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="perceptionProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="perceptionProf">Восприятие (Мудрость)</label>
        <span id="perceptionBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="survivalProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="survivalProf">Выживание (Мудрость)</label>
        <span id="survivalBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="deceptionProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="deceptionProf">Обман (Харизма)</label>
        <span id="deceptionBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="intimidationProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="intimidationProf">Запугивание (Харизма)</label>
        <span id="intimidationBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="performanceProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="performanceProf">Выступление (Харизма)</label>
        <span id="performanceBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="persuasionProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="persuasionProf">Убеждение (Харизма)</label>
        <span id="persuasionBonus">+0</span>
      </div>
    </div>
  </div>
</div>

<div class="tab" id="tabInventory">
  <div class="container">
    <h2>Инвентарь</h2>
    <div class="inventory-tabs">
      <button onclick="showInventoryTab('weapon')" class="inventory-tab-btn active">Оружие</button>
      <button onclick="showInventoryTab('armor')" class="inventory-tab-btn">Броня</button>
      <button onclick="showInventoryTab('material')" class="inventory-tab-btn">Материалы</button>
      <button onclick="showInventoryTab('misc')" class="inventory-tab-btn">Прочее</button>
      <button onclick="showInventoryTab('equipped')" class="inventory-tab-btn">Экипированное</button>
    </div>
    <div class="inventory-form">
      <label for="itemName">Название предмета</label>
      <input type="text" id="itemName" placeholder="Название предмета" maxlength="50">
      <label for="itemType">Тип предмета</label>
      <select id="itemType" onchange="updateInventoryForm()">
        <option value="weapon">Оружие</option>
        <option value="armor">Броня</option>
        <option value="material">Материал</option>
        <option value="food">Продовольствие</option>
        <option value="accessory">Аксессуар</option>
        <option value="misc">Разное</option>
      </select>
      <label for="weaponSubType" class="dynamic-field" id="weaponSubTypeField">Тип оружия</label>
      <select id="weaponSubType" class="dynamic-field">
        <option value="dagger">Кинжал</option>
        <option value="shortsword">Короткий меч</option>
        <option value="longsword">Длинный меч</option>
        <option value="greatsword">Двуручный меч</option>
        <option value="bow">Лук</option>
        <option value="crossbow">Арбалет</option>
        <option value="staff">Посох</option>
        <option value="mace">Булава</option>
        <option value="axe">Топор</option>
        <option value="spear">Копьё</option>
      </select>
      <label for="weaponCategory" class="dynamic-field" id="weaponCategoryField">Категория оружия</label>
      <select id="weaponCategory" class="dynamic-field">
        <option value="melee">Ближний бой</option>
        <option value="ranged">Дальний бой</option>
        <option value="magic">Магическое</option>
      </select>
      <label for="armorSubType" class="dynamic-field" id="armorSubTypeField">Тип брони</label>
      <select id="armorSubType" class="dynamic-field">
        <option value="leather">Кожаная броня</option>
        <option value="chainmail">Кольчуга</option>
        <option value="plate">Латная броня</option>
        <option value="shield">Щит</option>
      </select>
      <label for="armorMaterial" class="dynamic-field" id="armorMaterialField">Материал брони</label>
      <select id="armorMaterial" class="dynamic-field">
        <option value="leather">Кожа</option>
        <option value="studdedLeather">Укреплённая кожа</option>
        <option value="steel">Сталь</option>
        <option value="mithral">Мифрил</option>
        <option value="adamantine">Адамантин</option>
        <option value="dragonScale">Драконья чешуя</option>
      </select>
      <label for="itemQuality" class="dynamic-field" id="itemQualityField">Качество</label>
      <select id="itemQuality" class="dynamic-field">
        <option value="common">Обычное</option>
        <option value="improved">Улучшенное</option>
        <option value="masterwork">Мастерское</option>
        <option value="magic1">Магическое +1</option>
        <option value="magic2">Магическое +2</option>
        <option value="magic3">Магическое +3</option>
      </select>
      <label for="foodSubType" class="dynamic-field" id="foodSubTypeField">Тип продовольствия</label>
      <select id="foodSubType" class="dynamic-field">
        <option value="food">Еда</option>
        <option value="water">Вода</option>
      </select>
      <label for="accessorySubType" class="dynamic-field" id="accessorySubTypeField">Тип аксессуара</label>
      <select id="accessorySubType" class="dynamic-field">
        <option value="necklace">Ожерелье</option>
        <option value="ring">Кольцо</option>
        <option value="bracelet">Браслет</option>
        <option value="earrings">Серьги</option>
        <option value="cloak">Плащ</option>
      </select>
      <label for="acBonus" class="dynamic-field" id="acBonusField">Дополнительный бонус AC</label>
      <input type="number" min="0" max="3" id="acBonus" class="dynamic-field" placeholder="Бонус AC">
      <label for="energy" class="dynamic-field" id="energyField">Энергия (восстановление HP)</label>
      <input type="number" min="0" max="100" id="energy" class="dynamic-field" placeholder="Энергия">
      <label for="quantity" class="dynamic-field" id="quantityField">Количество</label>
      <input type="number" min="0" max="999" id="quantity" class="dynamic-field" placeholder="Количество">
      <label for="magicEffect" class="dynamic-field" id="magicEffectField">Магический эффект</label>
      <input type="text" id="magicEffect" class="dynamic-field" placeholder="Магический эффект" maxlength="100">
      <label for="itemDesc">Описание</label>
      <textarea id="itemDesc" placeholder="Описание" maxlength="200"></textarea>
      <button id="addItemBtn">Добавить предмет</button>
    </div>
    <div class="inventory-content active" id="inventoryWeapon"></div>
    <div class="inventory-content" id="inventoryArmor"></div>
    <div class="inventory-content" id="inventoryMaterial"></div>
    <div class="inventory-content" id="inventoryMisc"></div>
    <div class="inventory-content" id="inventoryEquipped"></div>
  </div>
</div>

<div class="tab" id="tabSpells">
  <div class="container">
    <h2>Заклинания</h2>
    <div class="spells-form">
      <label for="spellName">Название заклинания</label>
      <input type="text" id="spellName" placeholder="Название заклинания" maxlength="50">
      <label for="spellLevel">Уровень заклинания</label>
      <select id="spellLevel">
        <option value="0">Кантрип</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
      </select>
      <label for="spellCastingTime">Время произнесения</label>
      <input type="text" id="spellCastingTime" placeholder="Время произнесения" maxlength="50">
      <label for="spellRange">Дальность</label>
      <input type="text" id="spellRange" placeholder="Дальность" maxlength="50">
      <label for="spellDesc">Описание</label>
      <textarea id="spellDesc" placeholder="Описание" maxlength="200"></textarea>
      <button id="addSpellBtn">Добавить заклинание</button>
    </div>
    <h2>Слоты заклинаний</h2>
    <div class="spell-slots" id="spellSlotsContainer">
      <div class="spell-slot-item">
        <label for="slot1">1 уровень</label>
        <input type="number" min="0" max="4" id="slot1" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot2">2 уровень</label>
        <input type="number" min="0" max="3" id="slot2" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot3">3 уровень</label>
        <input type="number" min="0" max="3" id="slot3" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot4">4 уровень</label>
        <input type="number" min="0" max="3" id="slot4" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot5">5 уровень</label>
        <input type="number" min="0" max="3" id="slot5" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot6">6 уровень</label>
        <input type="number" min="0" max="2" id="slot6" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot7">7 уровень</label>
        <input type="number" min="0" max="2" id="slot7" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot8">8 уровень</label>
        <input type="number" min="0" max="1" id="slot8" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot9">9 уровень</label>
        <input type="number" min="0" max="1" id="slot9" value="0" oninput="saveToLocalStorage()">
      </div>
    </div>
    <div id="spellList"></div>
  </div>
</div>

<div class="tab notes" id="tabNotes">
  <div class="container">
    <h2>Заметки</h2>
    <label for="notesArea">Заметки</label>
    <textarea id="notesArea" oninput="saveToLocalStorage()"></textarea>
  </div>
</div>

<div class="tab settings" id="tabSettings">
  <div class="container">
    <h2>Настройки</h2>
    <button id="exportBtn">Экспорт JSON</button>
    <button id="importBtn">Импорт JSON</button>
    <button onclick="clearLocalStorage()">Сброс данных</button>
    <input type="file" id="importInput" style="display:none;" accept=".json">
    <label for="fileInput" class="sr-only">Загрузить Excel</label>
    <input type="file" id="fileInput" accept=".xlsx" onchange="handleFileUpload(event)">
  </div>
</div>

<div class="nav">
  <button onclick="showTab('tabCharacter')" class="nav-btn active">Персонаж</button>
  <button onclick="showTab('tabSkills')" class="nav-btn">Навыки</button>
  <button onclick="showTab('tabInventory')" class="nav-btn">Инвентарь</button>
  <button onclick="showTab('tabSpells')" class="nav-btn">Заклинания</button>
  <button onclick="showTab('tabNotes')" class="nav-btn">Заметки</button>
  <button onclick="showTab('tabSettings')" class="nav-btn">Настройки</button>
</div>

<script>
// LocalStorage
function saveToLocalStorage() {
  const data = {
    name: document.getElementById('charName').textContent,
    race: document.getElementById('charRace').textContent,
    "class": document.getElementById('charClass').textContent,
    level: document.getElementById('charLevel').textContent,
    xpCurrent: document.getElementById('xpCurrent').value,
    xpNext: document.getElementById('xpNext').value,
    abilities: {
      str: document.getElementById('str').value,
      dex: document.getElementById('dex').value,
      con: document.getElementById('con').value,
      int: document.getElementById('int').value,
      wis: document.getElementById('wis').value,
      cha: document.getElementById('cha').value
    },
    currentHP: document.getElementById('currentHP').value,
    maxHP: document.getElementById('maxHP').value,
    ac: document.getElementById('ac').value,
    profBonus: document.getElementById('profBonus').value,
    skills: {
      athleticsProf: document.getElementById('athleticsProf').checked,
      acrobaticsProf: document.getElementById('acrobaticsProf').checked,
      sleightOfHandProf: document.getElementById('sleightOfHandProf').checked,
      stealthProf: document.getElementById('stealthProf').checked,
      arcanaProf: document.getElementById('arcanaProf').checked,
      historyProf: document.getElementById('historyProf').checked,
      investigationProf: document.getElementById('investigationProf').checked,
      natureProf: document.getElementById('natureProf').checked,
      religionProf: document.getElementById('religionProf').checked,
      animalHandlingProf: document.getElementById('animalHandlingProf').checked,
      insightProf: document.getElementById('insightProf').checked,
      medicineProf: document.getElementById('medicineProf').checked,
      perceptionProf: document.getElementById('perceptionProf').checked,
      survivalProf: document.getElementById('survivalProf').checked,
      deceptionProf: document.getElementById('deceptionProf').checked,
      intimidationProf: document.getElementById('intimidationProf').checked,
      performanceProf: document.getElementById('performanceProf').checked,
      persuasionProf: document.getElementById('persuasionProf').checked
    },
    inventory: inventory,
    spells: spells,
    spellSlots: {
      slot1: document.getElementById('slot1').value,
      slot2: document.getElementById('slot2').value,
      slot3: document.getElementById('slot3').value,
      slot4: document.getElementById('slot4').value,
      slot5: document.getElementById('slot5').value,
      slot6: document.getElementById('slot6').value,
      slot7: document.getElementById('slot7').value,
      slot8: document.getElementById('slot8').value,
      slot9: document.getElementById('slot9').value
    },
    notes: document.getElementById('notesArea').value,
    avatar: avatarData
  };
  localStorage.setItem('characterData', JSON.stringify(data));
}

function loadFromLocalStorage() {
  try {
    const data = JSON.parse(localStorage.getItem('characterData') || '{}');
    // Установка начальных значений, если данные отсутствуют
    document.getElementById('charName').textContent = data.name || 'Mell';
    document.getElementById('charRace').textContent = data.race || 'Tiefling';
    document.getElementById('charClass').textContent = data.class || 'Ranger';
    document.getElementById('charLevel').textContent = data.level || '1';
    document.getElementById('xpCurrent').value = data.xpCurrent || '0';
    document.getElementById('xpNext').value = data.xpNext || '300';
    ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(stat => {
      if (data.abilities && data.abilities[stat] !== undefined) {
        document.getElementById(stat).value = data.abilities[stat];
      } else {
        document.getElementById(stat).value = 10; // Начальные значения
      }
      updateModifier(stat);
    });
    document.getElementById('currentHP').value = data.currentHP || '10';
    document.getElementById('maxHP').value = data.maxHP || '10';
    document.getElementById('ac').value = data.ac || '15';
    document.getElementById('profBonus').value = data.profBonus || '2';
    if (data.skills) {
      Object.keys(skillMap).forEach(skill => {
        const profId = skillMap[skill].profId;
        document.getElementById(profId).checked = data.skills[profId] || false;
      });
    } else {
      Object.keys(skillMap).forEach(skill => {
        document.getElementById(skillMap[skill].profId).checked = false;
      });
    }
    inventory = data.inventory || [];
    spells = data.spells || [];
    if (data.spellSlots) {
      ['slot1', 'slot2', 'slot3', 'slot4', 'slot5', 'slot6', 'slot7', 'slot8', 'slot9'].forEach(slot => {
        document.getElementById(slot).value = data.spellSlots[slot] || '0';
      });
    }
    renderInventory();
    renderSpells();
    document.getElementById('notesArea').value = data.notes || '';
    if (data.avatar) {
      avatarData = data.avatar;
      document.getElementById('avatarPreview').style.backgroundImage = `url(${avatarData})`;
    }
    updateSkills();
    updateInventoryForm();
    updateAC();
    updateXP();
  } catch (error) {
    console.error('Ошибка загрузки из localStorage:', error);
  }
}

function clearLocalStorage() {
  if (confirm('Сбросить все данные персонажа?')) {
    localStorage.removeItem('characterData');
    location.reload();
  }
}

// Settings: export/import
document.getElementById('exportBtn').addEventListener('click', () => {
  const data = {
    name: document.getElementById('charName').textContent,
    race: document.getElementById('charRace').textContent,
    "class": document.getElementById('charClass').textContent,
    level: document.getElementById('charLevel').textContent,
    xpCurrent: document.getElementById('xpCurrent').value,
    xpNext: document.getElementById('xpNext').value,
    abilities: {
      str: document.getElementById('str').value,
      dex: document.getElementById('dex').value,
      con: document.getElementById('con').value,
      int: document.getElementById('int').value,
      wis: document.getElementById('wis').value,
      cha: document.getElementById('cha').value
    },
    currentHP: document.getElementById('currentHP').value,
    maxHP: document.getElementById('maxHP').value,
    ac: document.getElementById('ac').value,
    profBonus: document.getElementById('profBonus').value,
    skills: {
      athleticsProf: document.getElementById('athleticsProf').checked,
      acrobaticsProf: document.getElementById('acrobaticsProf').checked,
      sleightOfHandProf: document.getElementById('sleightOfHandProf').checked,
      stealthProf: document.getElementById('stealthProf').checked,
      arcanaProf: document.getElementById('arcanaProf').checked,
      historyProf: document.getElementById('historyProf').checked,
      investigationProf: document.getElementById('investigationProf').checked,
      natureProf: document.getElementById('natureProf').checked,
      religionProf: document.getElementById('religionProf').checked,
      animalHandlingProf: document.getElementById('animalHandlingProf').checked,
      insightProf: document.getElementById('insightProf').checked,
      medicineProf: document.getElementById('medicineProf').checked,
      perceptionProf: document.getElementById('perceptionProf').checked,
      survivalProf: document.getElementById('survivalProf').checked,
      deceptionProf: document.getElementById('deceptionProf').checked,
      intimidationProf: document.getElementById('intimidationProf').checked,
      performanceProf: document.getElementById('performanceProf').checked,
      persuasionProf: document.getElementById('persuasionProf').checked
    },
    inventory: inventory,
    spells: spells,
    spellSlots: {
      slot1: document.getElementById('slot1').value,
      slot2: document.getElementById('slot2').value,
      slot3: document.getElementById('slot3').value,
      slot4: document.getElementById('slot4').value,
      slot5: document.getElementById('slot5').value,
      slot6: document.getElementById('slot6').value,
      slot7: document.getElementById('slot7').value,
      slot8: document.getElementById('slot8').value,
      slot9: document.getElementById('slot9').value
    },
    notes: document.getElementById('notesArea').value,
    avatar: avatarData
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'character.json';
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('importBtn').addEventListener('click', () => {
  document.getElementById('importInput').click();
});

document.getElementById('importInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const data = JSON.parse(ev.target.result);
        localStorage.setItem('characterData', JSON.stringify(data));
        loadFromLocalStorage();
      } catch (error) {
        alert('Ошибка импорта JSON: неверный формат файла');
      }
    };
    reader.onerror = function() {
      alert('Ошибка чтения файла');
    };
    reader.readAsText(file);
  }
});
</script>
</body>
</html>
