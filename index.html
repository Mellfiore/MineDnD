<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D&D: Morgland</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --dark-bg: #1A1A1A;
    --dark-panel: #2C2C2C;
    --accent-blue: #007BFF;
    --accent-red: #FF4C4C;
    --text-white: #FFFFFF;
    --text-gray: #A9A9A9;
    --progress-bg: #4A4A4A;
    --progress-fill: #32CD32;
    --quality-common: #A9A9A9;
    --quality-uncommon: #00FF00;
    --quality-rare: #0000FF;
    --quality-epic: #800080;
    --quality-legendary: #FFA500;
    --quality-artifact: #FFD700;
    --input-bg: #3A3A3A;
    --input-border: #555555;
  }
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Noto Sans', sans-serif;
    background-color: var(--dark-bg);
    color: var(--text-white);
    overflow-x: hidden;
  }
  header {
    padding: 12px;
    background: var(--dark-panel);
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 100%;
  }
  header h1 {
    margin: 4px 0;
    font-size: 20pt;
    text-align: center;
  }
  header .sub {
    font-size: 12pt;
    color: var(--text-gray);
    text-align: center;
  }
  header .sub span {
    padding: 0 4px;
  }
  header .sub span[contenteditable] {
    padding: 2px 4px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 4px;
  }
  nav {
    display: flex;
    justify-content: space-around;
    background: var(--dark-panel);
    padding: 8px 0;
    position: fixed;
    bottom: 0;
    width: 100%;
    max-width: 100%;
    z-index: 100;
    height: 60px;
  }
  nav button.nav-btn {
    background: none;
    border: none;
    color: var(--text-white);
    font-size: 14pt;
    cursor: pointer;
    padding: 6px;
    transition: color 0.3s;
  }
  nav button.nav-btn.active {
    border-bottom: 2px solid var(--accent-blue);
    color: var(--accent-blue);
  }
  nav button.nav-btn:hover {
    color: #66b3ff;
  }
  .tab {
    display: none;
    padding: 12px;
    padding-bottom: 80px;
    max-width: 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
    text-align: center;
  }
  .tab.active-tab {
    display: block;
    opacity: 1;
  }
  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 12px;
  }
  .abilities {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 12px;
    max-width: 100%;
    justify-content: center;
  }
  .ability-card {
    background: var(--dark-panel);
    padding: 8px;
    border-radius: 8px;
    text-align: center;
  }
  .ability-card label {
    display: block;
    margin-bottom: 4px;
  }
  .ability-card input {
    width: 60px;
    font-size: 16pt;
    text-align: center;
    background: var(--input-bg);
    color: var(--text-white);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    padding: 2px;
  }
  .ability-card span {
    display: block;
    font-size: 12pt;
    color: var(--text-gray);
  }
  .skills, .spell-slots {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 12px;
    max-width: 100%;
    justify-content: center;
  }
  .skill-item, .spell-slot-item {
    background: var(--dark-panel);
    padding: 8px;
    border-radius: 8px;
    text-align: center;
  }
  .skill-item label, .spell-slot-item label {
    display: block;
    margin-bottom: 4px;
  }
  .skill-item input {
    margin-right: 8px;
  }
  .dice-row {
  margin-top: 12px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
}

.dice-button {
  background: linear-gradient(135deg, #f0f0f0, #ffffff);
  color: #111;
  border: 2px solid #cfcfcf;
  font-weight: 700;
  font-size: 0.95rem;
  cursor: pointer;
  transition: transform 0.16s ease, box-shadow 0.16s ease;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.35);
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  position: relative;
  user-select: none;
  width: 64px;
  height: 64px;
  line-height: 1;
  border-radius: 8px; /* для кубиков с clip-path это не сильно заметно */
}

/* Размеры подобраны так, чтобы формы имели близкую площадь */
.dice-button[data-dice="4"]  { clip-path: polygon(50% 0%, 100% 100%, 0% 100%); width:52px; height:52px; }
.dice-button[data-dice="6"]  { clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); width:52px; height:52px; border-radius:6px; }
.dice-button[data-dice="8"]  { clip-path: polygon(50% 0%, 88% 33%, 66% 100%, 34% 100%, 12% 33%); width:56px; height:56px; }
.dice-button[data-dice="10"] {
  clip-path: polygon(
    50% 0%, 78% 9%, 94% 30%, 90% 60%, 70% 92%,
    50% 100%, 30% 92%, 10% 60%, 6% 30%, 22% 9%
  );
  width:60px; height:60px;
}
.dice-button[data-dice="12"] {
  clip-path: polygon(
    50% 0%, 68% 6%, 84% 20%, 94% 38%, 98% 58%, 91% 76%,
    76% 90%, 50% 100%, 24% 90%, 9% 76%, 2% 58%, 6% 38%, 16% 20%, 32% 6%
  );
  width:64px; height:64px;
}
.dice-button[data-dice="20"] {
  clip-path: polygon(
    50% 0%, 66% 8%, 80% 22%, 92% 38%, 98% 56%, 90% 74%,
    76% 88%, 50% 100%, 24% 88%, 10% 74%, 2% 56%, 8% 38%, 20% 22%, 34% 8%
  );
  width:68px; height:68px;
}
.dice-button[data-dice="100"] {
  clip-path: circle(50% at 50% 50%);
  width:76px; height:76px;
  border-radius:50%;
}

/* Гарантируем центровку текста и защиту от обрезки */
.dice-button > span {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 84%;
  height: 84%;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 800;
  color: #222;
  font-size: 0.98rem;
}

/* Фокус и hover */
.dice-button:focus { outline: 3px solid rgba(0,123,255,0.18); }
.dice-button:hover { transform: translateY(-4%) scale(1.03); box-shadow: 4px 6px 14px rgba(0,0,0,0.45); }

  }
  .inventory-item, .spell-item, .note-item {
    background: var(--dark-panel);
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-align: left;
  }
  .inventory-item span, .spell-item span, .note-item span {
    flex: 1;
  }
  .inventory-item .quality {
    font-weight: bold;
  }
  .quality-common { color: var(--quality-common); }
  .quality-uncommon { color: var(--quality-uncommon); }
  .quality-rare { color: var(--quality-rare); }
  .quality-epic { color: var(--quality-epic); }
  .quality-legendary { color: var(--quality-legendary); }
  .quality-artifact { color: var(--quality-artifact); }
  .inventory-item button, .spell-item button, .note-item button {
    margin-left: 4px;
    background: var(--accent-red);
    border: none;
    color: var(--text-white);
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
  }
  .inventory-form input, .inventory-form select, .spells-form input, .spells-form select, .notes-form input {
    margin-bottom: 6px;
    width: 100%;
    padding: 6px;
    border-radius: 4px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text-white);
    text-align: center;
  }
  .notes textarea, .spells-form textarea {
    width: 100%;
    height: 200px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text-white);
    text-align: center;
  }
  .note-section {
    margin-top: 12px;
    border: 1px solid var(--text-gray);
    border-radius: 8px;
    padding: 8px;
  }
  .settings button, .inventory-form button, .spells-form button, .notes-form button {
    width: 100%;
    margin: 4px 0;
    padding: 8px;
    border: none;
    background: linear-gradient(45deg, var(--accent-blue), #0056b3);
    color: var(--text-white);
    font-weight: bold;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    transition: transform 0.2s;
  }
  .settings button:hover, .inventory-form button:hover, .spells-form button:hover, .notes-form button:hover {
    transform: translateY(-2px);
  }
  .avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    margin: 8px auto;
    border: 2px solid var(--accent-blue);
  }
  .stats {
    display: flex;
    justify-content: center;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  .xp {
    margin-top: 12px;
    max-width: 100%;
    text-align: center;
  }
  .xp label {
    display: block;
    margin-bottom: 4px;
  }
  .xp input {
    width: 80px;
    padding: 6px;
    background: var(--input-bg);
    color: var(--text-white);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    text-align: center;
    margin: 0 4px;
  }
  .progress-bar {
    width: 100%;
    background: var(--progress-bg);
    border-radius: 4px;
    height: 20px;
    overflow: hidden;
    margin: 8px 0;
  }
  .progress-fill {
    height: 100%;
    background: var(--progress-fill);
    transition: width 0.3s ease;
  }
  .xp button {
    margin-top: 8px;
    background: var(--accent-blue);
    color: var(--text-white);
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
  }
  .inventory-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
  }
  .inventory-tabs button {
    background: none;
    border: none;
    color: var(--text-white);
    font-size: 12pt;
    cursor: pointer;
    padding: 6px;
  }
  .inventory-tabs button.active {
    border-bottom: 2px solid var(--accent-blue);
  }
  .inventory-content {
    display: none;
  }
  .inventory-content.active {
    display: block;
  }
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }
  .inventory-form .dynamic-field, .spells-form .dynamic-field, .notes-form .dynamic-field {
    display: none;
  }
  .inventory-form .dynamic-field.active, .spells-form .dynamic-field.active, .notes-form .dynamic-field.active {
    display: block;
  }
  .inventory-item input[type="checkbox"] {
    margin-left: 8px;
  }
  @media (max-width: 500px) {
    .abilities {
      grid-template-columns: 1fr;
    }
  }
  @media (max-width: 600px) {
    .skills, .spell-slots {
      grid-template-columns: repeat(2, 1fr);
    }
    header h1 {
      font-size: 16pt;
    }
    header .sub {
      font-size: 10pt;
    }
    .tab {
      padding: 8px;
      padding-bottom: 70px;
    }
    .container {
      max-width: 100%;
      margin: 0;
      padding: 0 8px;
    }
  }
  @media (max-width: 400px) {
    .skills, .spell-slots {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body onload="loadFromLocalStorage(); initializeTabs();">

<header>
  <div class="avatar-preview" id="avatarPreview" role="img" aria-label="Персонаж"></div>
  <label for="avatarInput" class="sr-only">Загрузить аватар</label>
  <input type="file" id="avatarInput" accept="image/*">
  <h1 contenteditable="true" id="charName" oninput="limitContentLength('charName', 50); saveToLocalStorage()">Имя персонажа</h1>
  <div class="sub">
    Раса: <span contenteditable="true" id="charRace" oninput="limitContentLength('charRace', 30); saveToLocalStorage()">Раса</span> |
    Класс: <span contenteditable="true" id="charClass" oninput="limitContentLength('charClass', 30); saveToLocalStorage()">Класс</span> |
    Уровень: <span contenteditable="true" id="charLevel" oninput="limitContentLength('charLevel', 3); saveToLocalStorage()">1</span>
  </div>
</header>

<div class="tab active-tab" id="tabCharacter">
  <div class="container">
    <h2>Характеристики</h2>
    <div class="stats">
      <label>Текущее HP: <input type="number" min="0" max="999" id="currentHP" value="10" oninput="validateHP(); saveToLocalStorage()"></label>
      <label>Макс. HP: <input type="number" min="0" max="999" id="maxHP" value="10" oninput="validateHP(); saveToLocalStorage()"></label>
      <label>AC: <input type="number" min="0" max="50" id="ac" value="15" readonly></label>
      <label>Proficiency Bonus: <input type="number" min="2" max="6" id="profBonus" value="2" readonly></label>
    </div>
    <h2>Опыт</h2>
    <div class="xp">
      <label for="xpCurrent">Текущий XP</label>
      <input type="number" min="0" id="xpCurrent" value="0" oninput="updateXP(); saveToLocalStorage()">
      <label for="xpNext">XP до следующего уровня</label>
      <input type="number" min="0" id="xpNext" value="300" readonly>
      <div class="progress-bar">
        <div class="progress-fill" id="xpProgress" style="width:0%"></div>
      </div>
      <button onclick="addXP()">Добавить XP</button>
      <button onclick="levelUp()">Повысить уровень</button>
    </div>
    <h2>Способности</h2>
    <div class="abilities" id="abilitiesContainer">
      <div class="ability-card">
        <label for="str">Сила</label>
        <input type="number" min="1" max="30" value="10" id="str" oninput="updateModifier('str'); updateSkills(); updateAC(); saveToLocalStorage()">
        <span id="strMod">Mod: +0</span>
      </div>
      <div class="ability-card">
        <label for="dex">Ловкость</label>
        <input type="number" min="1" max="30" value="10" id="dex" oninput="updateModifier('dex'); updateSkills(); updateAC(); saveToLocalStorage()">
        <span id="dexMod">Mod: +0</span>
      </div>
      <div class="ability-card">
        <label for="con">Телосложение</label>
        <input type="number" min="1" max="30" value="10" id="con" oninput="updateModifier('con'); updateSkills(); saveToLocalStorage()">
        <span id="conMod">Mod: +0</span>
      </div>
      <div class="ability-card">
        <label for="int">Интеллект</label>
        <input type="number" min="1" max="30" value="10" id="int" oninput="updateModifier('int'); updateSkills(); saveToLocalStorage()">
        <span id="intMod">Mod: +0</span>
      </div>
      <div class="ability-card">
        <label for="wis">Мудрость</label>
        <input type="number" min="1" max="30" value="10" id="wis" oninput="updateModifier('wis'); updateSkills(); saveToLocalStorage()">
        <span id="wisMod">Mod: +0</span>
      </div>
      <div class="ability-card">
        <label for="cha">Харизма</label>
        <input type="number" min="1" max="30" value="10" id="cha" oninput="updateModifier('cha'); updateSkills(); saveToLocalStorage()">
        <span id="chaMod">Mod: +0</span>
      </div>
    </div>
    <h2>Броски кубиков</h2>
    <select id="diceAbility">
      <option value="none">Без модификатора</option>
      <option value="str">Проверка Силы</option>
      <option value="dex">Проверка Ловкости</option>
      <option value="con">Проверка Телосложения</option>
      <option value="int">Проверка Интеллекта</option>
      <option value="wis">Проверка Мудрости</option>
      <option value="cha">Проверка Харизмы</option>
      <option value="athletics">Атлетика</option>
      <option value="acrobatics">Акробатика</option>
      <option value="sleightOfHand">Ловкость рук</option>
      <option value="stealth">Скрытность</option>
      <option value="arcana">Магия</option>
      <option value="history">История</option>
      <option value="investigation">Расследование</option>
      <option value="nature">Природа</option>
      <option value="religion">Религия</option>
      <option value="animalHandling">Обращение с животными</option>
      <option value="insight">Проницательность</option>
      <option value="medicine">Медицина</option>
      <option value="perception">Восприятие</option>
      <option value="survival">Выживание</option>
      <option value="deception">Обман</option>
      <option value="intimidation">Запугивание</option>
      <option value="performance">Выступление</option>
      <option value="persuasion">Убеждение</option>
    </select>
    <div class="dice-row">
      <button class="dice-button" data-dice="4"><span>D4</span></button>
      <button class="dice-button" data-dice="6"><span>D6</span></button>
      <button class="dice-button" data-dice="8"><span>D8</span></button>
      <button class="dice-button" data-dice="10"><span>D10</span></button>
      <button class="dice-button" data-dice="12"><span>D12</span></button>
      <button class="dice-button" data-dice="20"><span>D20</span></button>
      <button class="dice-button" data-dice="100"><span>D100</span></button>
    </div>
    <div id="diceResult" style="margin-top:12px;text-align:center;font-size:16pt;white-space:pre-wrap;"></div>
  </div>
</div>

<div class="tab" id="tabSkills">
  <div class="container">
    <h2>Навыки</h2>
    <div class="skills" id="skillsContainer">
      <div class="skill-item">
        <input type="checkbox" id="athleticsProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="athleticsProf">Атлетика (Сила)</label>
        <span id="athleticsBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="acrobaticsProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="acrobaticsProf">Акробатика (Ловкость)</label>
        <span id="acrobaticsBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="sleightOfHandProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="sleightOfHandProf">Ловкость рук (Ловкость)</label>
        <span id="sleightOfHandBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="stealthProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="stealthProf">Скрытность (Ловкость)</label>
        <span id="stealthBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="arcanaProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="arcanaProf">Магия (Интеллект)</label>
        <span id="arcanaBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="historyProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="historyProf">История (Интеллект)</label>
        <span id="historyBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="investigationProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="investigationProf">Расследование (Интеллект)</label>
        <span id="investigationBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="natureProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="natureProf">Природа (Интеллект)</label>
        <span id="natureBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="religionProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="religionProf">Религия (Интеллект)</label>
        <span id="religionBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="animalHandlingProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="animalHandlingProf">Обращение с животными (Мудрость)</label>
        <span id="animalHandlingBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="insightProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="insightProf">Проницательность (Мудрость)</label>
        <span id="insightBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="medicineProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="medicineProf">Медицина (Мудрость)</label>
        <span id="medicineBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="perceptionProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="perceptionProf">Восприятие (Мудрость)</label>
        <span id="perceptionBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="survivalProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="survivalProf">Выживание (Мудрость)</label>
        <span id="survivalBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="deceptionProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="deceptionProf">Обман (Харизма)</label>
        <span id="deceptionBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="intimidationProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="intimidationProf">Запугивание (Харизма)</label>
        <span id="intimidationBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="performanceProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="performanceProf">Выступление (Харизма)</label>
        <span id="performanceBonus">+0</span>
      </div>
      <div class="skill-item">
        <input type="checkbox" id="persuasionProf" onchange="updateSkills(); saveToLocalStorage()">
        <label for="persuasionProf">Убеждение (Харизма)</label>
        <span id="persuasionBonus">+0</span>
      </div>
    </div>
  </div>
</div>

<div class="tab" id="tabInventory">
  <div class="container">
    <h2>Инвентарь</h2>
    <div class="inventory-tabs">
      <button onclick="showInventoryTab('weapon')" class="inventory-tab-btn active">Оружие</button>
      <button onclick="showInventoryTab('armor')" class="inventory-tab-btn">Броня</button>
      <button onclick="showInventoryTab('material')" class="inventory-tab-btn">Материалы</button>
      <button onclick="showInventoryTab('misc')" class="inventory-tab-btn">Прочее</button>
      <button onclick="showInventoryTab('equipped')" class="inventory-tab-btn">Экипированное</button>
    </div>
    <div class="inventory-form">
      <label for="itemName">Название предмета</label>
      <input type="text" id="itemName" placeholder="Название предмета" maxlength="50">
      <label for="itemType">Тип предмета</label>
      <select id="itemType" onchange="updateInventoryForm()">
        <option value="weapon">Оружие</option>
        <option value="armor">Броня</option>
        <option value="material">Материал</option>
        <option value="food">Продовольствие</option>
        <option value="accessory">Аксессуар</option>
        <option value="misc">Разное</option>
      </select>
      <label for="weaponSubType" class="dynamic-field" id="weaponSubTypeField">Тип оружия</label>
      <select id="weaponSubType" class="dynamic-field" onchange="updateWeaponCategory()">
        <option value="dagger">Кинжал</option>
        <option value="shortsword">Короткий меч</option>
        <option value="longsword">Длинный меч</option>
        <option value="greatsword">Двуручный меч</option>
        <option value="bow">Лук</option>
        <option value="crossbow">Арбалет</option>
        <option value="staff">Посох</option>
        <option value="mace">Булава</option>
        <option value="axe">Топор</option>
        <option value="spear">Копьё</option>
      </select>
      <label for="weaponCategory" class="dynamic-field" id="weaponCategoryField">Категория оружия</label>
      <select id="weaponCategory" class="dynamic-field">
        <option value="melee">Ближний бой</option>
        <option value="ranged">Дальний бой</option>
        <option value="magic">Магическое</option>
      </select>
      <label for="armorSubType" class="dynamic-field" id="armorSubTypeField">Тип брони</label>
      <select id="armorSubType" class="dynamic-field" onchange="updateArmorMaterialOptions()">
        <option value="helmet">Шлем</option>
        <option value="chestplate">Нагрудник</option>
        <option value="leggings">Поножи</option>
        <option value="boots">Ботинки</option>
        <option value="gloves">Перчатки</option>
        <option value="shield">Щит</option>
      </select>
      <label for="armorMaterial" class="dynamic-field" id="armorMaterialField">Материал брони</label>
      <select id="armorMaterial" class="dynamic-field">
        <option value="leather">Кожа</option>
        <option value="studdedLeather">Укреплённая кожа</option>
        <option value="steel">Сталь</option>
        <option value="mithral">Мифрил</option>
        <option value="adamantine">Адамантин</option>
        <option value="dragonScale">Драконья чешуя</option>
      </select>
      <label for="itemQuality" class="dynamic-field" id="itemQualityField">Качество</label>
      <select id="itemQuality" class="dynamic-field">
        <option value="common">Обычное</option>
        <option value="uncommon">Необычное</option>
        <option value="rare">Редкое</option>
        <option value="epic">Эпическое</option>
        <option value="legendary">Легендарное</option>
        <option value="artifact">Артефакт</option>
      </select>
      <label for="foodSubType" class="dynamic-field" id="foodSubTypeField">Тип продовольствия</label>
      <select id="foodSubType" class="dynamic-field">
        <option value="food">Еда</option>
        <option value="water">Вода</option>
      </select>
      <label for="accessorySubType" class="dynamic-field" id="accessorySubTypeField">Тип аксессуара</label>
      <select id="accessorySubType" class="dynamic-field">
        <option value="necklace">Ожерелье</option>
        <option value="ring">Кольцо</option>
        <option value="bracelet">Браслет</option>
        <option value="earrings">Серьги</option>
        <option value="cloak">Плащ</option>
      </select>
      <label for="acBonus" class="dynamic-field" id="acBonusField">Дополнительный бонус AC</label>
      <input type="number" min="0" max="3" id="acBonus" class="dynamic-field" placeholder="Бонус AC">
      <label for="energy" class="dynamic-field" id="energyField">Восстановление HP</label>
      <input type="number" min="0" max="100" id="energy" class="dynamic-field" placeholder="Восстановление HP" required>
      <label for="quantity" class="dynamic-field" id="quantityField">Количество</label>
      <input type="number" min="0" max="999" id="quantity" class="dynamic-field" placeholder="Количество" required>
      <label for="magicEffect" class="dynamic-field" id="magicEffectField">Магический эффект</label>
      <select id="magicEffect" class="dynamic-field" required>
        <option value="">Выберите эффект</option>
        <option value="+1 к AC">+1 к AC</option>
        <option value="+1 к Силе">+1 к Силе</option>
        <option value="Невидимость раз в день">Невидимость раз в день</option>
        <option value="Сопротивление огню">Сопротивление огню</option>
        <option value="Лечение">Лечение</option>
        <option value="Телепортация">Телепортация</option>
        <option value="Тёмное зрение">Тёмное зрение</option>
        <option value="custom">Кастомный (укажите в описании)</option>
      </select>
      <label for="itemDesc">Описание</label>
      <textarea id="itemDesc" placeholder="Описание" maxlength="200"></textarea>
      <button id="addItemBtn">Добавить предмет</button>
    </div>
    <div class="inventory-content active" id="inventoryWeapon"></div>
    <div class="inventory-content" id="inventoryArmor"></div>
    <div class="inventory-content" id="inventoryMaterial"></div>
    <div class="inventory-content" id="inventoryMisc"></div>
    <div class="inventory-content" id="inventoryEquipped"></div>
  </div>
</div>

<div class="tab" id="tabSpells">
  <div class="container">
    <h2>Заклинания</h2>
    <div class="spells-form">
      <label for="spellName">Название заклинания</label>
      <input type="text" id="spellName" placeholder="Название заклинания" maxlength="50">
      <label for="spellLevel">Уровень заклинания</label>
      <select id="spellLevel">
        <option value="0">Кантрип</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
      </select>
      <label for="spellCastingTime">Время произнесения</label>
      <input type="text" id="spellCastingTime" placeholder="Пример: 1 действие, 1 минута" maxlength="50">
      <label for="spellRange">Дальность</label>
      <input type="text" id="spellRange" placeholder="Пример: 30 футов, прикосновение" maxlength="50">
      <label for="spellDesc">Описание</label>
      <textarea id="spellDesc" placeholder="Описание" maxlength="200"></textarea>
      <button id="addSpellBtn">Добавить заклинание</button>
    </div>
    <h2>Слоты заклинаний</h2>
    <div class="spell-slots" id="spellSlotsContainer">
      <div class="spell-slot-item">
        <label for="slot1">1 уровень</label>
        <input type="number" min="0" max="4" id="slot1" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot2">2 уровень</label>
        <input type="number" min="0" max="3" id="slot2" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot3">3 уровень</label>
        <input type="number" min="0" max="3" id="slot3" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot4">4 уровень</label>
        <input type="number" min="0" max="3" id="slot4" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot5">5 уровень</label>
        <input type="number" min="0" max="3" id="slot5" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot6">6 уровень</label>
        <input type="number" min="0" max="2" id="slot6" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot7">7 уровень</label>
        <input type="number" min="0" max="2" id="slot7" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot8">8 уровень</label>
        <input type="number" min="0" max="1" id="slot8" value="0" oninput="saveToLocalStorage()">
      </div>
      <div class="spell-slot-item">
        <label for="slot9">9 уровень</label>
        <input type="number" min="0" max="1" id="slot9" value="0" oninput="saveToLocalStorage()">
      </div>
    </div>
    <div id="spellList"></div>
  </div>
</div>

<div class="tab notes" id="tabNotes">
  <div class="container">
    <h2>Заметки</h2>
    <div class="notes-form">
      <label for="noteTitle">Заголовок заметки</label>
      <input type="text" id="noteTitle" placeholder="Введите заголовок" maxlength="50">
      <label for="noteContent">Содержание</label>
      <textarea id="noteContent" placeholder="Введите текст заметки" maxlength="500"></textarea>
      <button id="addNoteBtn">Добавить заметку</button>
    </div>
    <div id="notesList"></div>
    <label for="generalNotes">Общие заметки</label>
    <textarea id="generalNotes" oninput="saveToLocalStorage()"></textarea>
  </div>
</div>

<div class="tab settings" id="tabSettings">
  <div class="container">
    <h2>Настройки</h2>
    <button id="exportBtn">Экспорт JSON</button>
    <button id="importBtn">Импорт JSON</button>
    <button onclick="clearLocalStorage()">Сброс данных</button>
    <input type="file" id="importInput" style="display:none;" accept=".json">
    <label for="fileInput" class="sr-only">Загрузить Excel</label>
    <input type="file" id="fileInput" accept=".xlsx" onchange="handleFileUpload(event)">
  </div>
</div>

<nav>
  <button class="nav-btn" onclick="showTab('tabCharacter')">Персонаж</button>
  <button class="nav-btn" onclick="showTab('tabSkills')">Навыки</button>
  <button class="nav-btn" onclick="showTab('tabInventory')">Инвентарь</button>
  <button class="nav-btn" onclick="showTab('tabSpells')">Заклинания</button>
  <button class="nav-btn" onclick="showTab('tabNotes')">Заметки</button>
  <button class="nav-btn" onclick="showTab('tabSettings')">Настройки</button>
</nav>

<script>
var gk_isXlsx = false;
var gk_xlsxFileLookup = {};
var gk_fileData = {};

function filledCell(cell) {
  return cell !== '' && cell != null;
}

function loadFileData(filename) {
  if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
    try {
      var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
      var firstSheetName = workbook.SheetNames[0];
      var worksheet = workbook.Sheets[firstSheetName];
      var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
      var filteredData = jsonData.filter(row => row.some(filledCell));
      var headerRowIndex = filteredData.findIndex((row, index) =>
        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
      );
      if (headerRowIndex === -1 || headerRowIndex > 25) {
        headerRowIndex = 0;
      }
      var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
      csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
      return csv;
    } catch (e) {
      console.error('Ошибка обработки XLSX:', e);
      return "";
    }
  }
  return gk_fileData[filename] || "";
}

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = e.target.result;
      gk_fileData[file.name] = data.split(',')[1];
      gk_xlsxFileLookup[file.name] = true;
      gk_isXlsx = true;
      console.log('Файл загружен:', file.name);
    };
    reader.readAsDataURL(file);
  }
}

// Инициализация вкладок
function initializeTabs() {
  console.log('Инициализация вкладок...');
  showTab('tabCharacter'); // Устанавливаем начальную вкладку
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const tabId = btn.getAttribute('onclick').match(/showTab\('(.+)'\)/)[1];
      showTab(tabId);
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });
}

// Переключение вкладок
function showTab(tabId) {
  console.log('Переключение на вкладку:', tabId);
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active-tab');
    if (tab.id === tabId) {
      tab.classList.add('active-tab');
    }
  });
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
}

// Переключение вкладок инвентаря
function showInventoryTab(tabId) {
  document.querySelectorAll('.inventory-content').forEach(content => content.classList.remove('active'));
  document.getElementById(`inventory${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');
  document.querySelectorAll('.inventory-tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`button[onclick="showInventoryTab('${tabId}')"]`).classList.add('active');
  renderInventory();
}

// Предотвращение Enter в contenteditable
function preventEnter(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    event.target.blur(); // Снимаем фокус после Enter
    console.log('Enter предотвращён для:', event.target.id);
  }
}

// Ограничение длины и предотвращение Enter
function limitContentLength(id, maxLength) {
  const element = document.getElementById(id);
  if (element.textContent.length > maxLength) {
    element.textContent = element.textContent.slice(0, maxLength);
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(element);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
  }
  saveToLocalStorage();
}

// Обработчик для уровня (только цифры)
function handleLevelInput(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    event.target.blur();
    limitContentLength('charLevel', 3);
  } else if (!/^\d*$/.test(event.key)) {
    event.preventDefault();
  } else {
    limitContentLength('charLevel', 3); // Ограничиваем длину при вводе
  }
  saveToLocalStorage();
}

// Валидация HP
function validateHP() {
  const currentHP = parseInt(document.getElementById('currentHP').value) || 0;
  const maxHP = parseInt(document.getElementById('maxHP').value) || 0;
  if (currentHP > maxHP) {
    document.getElementById('currentHP').value = maxHP;
  }
  if (currentHP < 0) {
    document.getElementById('currentHP').value = 0;
  }
  saveToLocalStorage();
}

// Опыт и уровень
const levelXP = [0, 300, 900, 2700, 6500, 14000, 23000, 34000, 48000, 64000, 85000, 100000, 120000, 140000, 165000, 195000, 225000, 265000, 305000, 355000];
function updateXP() {
  const currentXP = parseInt(document.getElementById('xpCurrent').value) || 0;
  const level = parseInt(document.getElementById('charLevel').textContent) || 1;
  const nextLevelXP = levelXP[Math.min(level, 19)] || 355000;
  document.getElementById('xpNext').value = nextLevelXP;
  const progressPercent = Math.min((currentXP / nextLevelXP) * 100, 100);
  document.getElementById('xpProgress').style.width = `${progressPercent}%`;
  if (currentXP >= nextLevelXP && level < 20) {
    document.getElementById('charLevel').textContent = level + 1;
    document.getElementById('profBonus').value = Math.floor((level + 1 - 1) / 4) + 2;
    updateSkills();
  }
  saveToLocalStorage();
}
function addXP() {
  const xpInput = prompt('Введите количество XP для добавления:');
  const xpToAdd = parseInt(xpInput) || 0;
  if (xpToAdd > 0) {
    const currentXP = parseInt(document.getElementById('xpCurrent').value) || 0;
    document.getElementById('xpCurrent').value = currentXP + xpToAdd;
    updateXP();
  }
}
function levelUp() {
  const level = parseInt(document.getElementById('charLevel').textContent) || 1;
  if (level < 20) {
    document.getElementById('charLevel').textContent = level + 1;
    document.getElementById('profBonus').value = Math.floor((level + 1 - 1) / 4) + 2;
    document.getElementById('xpCurrent').value = levelXP[level] || 0;
    updateXP();
    updateSkills();
  } else {
    alert('Достигнут максимальный уровень (20)!');
  }
}

// Модификатор способностей
function updateModifier(stat) {
  const value = parseInt(document.getElementById(stat).value) || 10;
  const mod = Math.floor((value - 10) / 2);
  document.getElementById(`${stat}Mod`).textContent = `Mod: ${mod >= 0 ? '+' : ''}${mod}`;
}

// Обновление AC
const armorBaseAC = {
  helmet: 2,
  chestplate: 5,
  leggings: 4,
  boots: 1,
  gloves: 1,
  shield: 2
};
const materialModifiers = {
  leather: { helmet: 0, chestplate: 0, leggings: 0, boots: 0, gloves: 0, shield: 0 },
  studdedLeather: { helmet: 1, chestplate: 1, leggings: 1, boots: 1, gloves: 1, shield: 0 },
  steel: { helmet: 2, chestplate: 3, leggings: 2, boots: 1, gloves: 1, shield: 2 },
  mithral: { helmet: 2, chestplate: 3, leggings: 2, boots: 1, gloves: 1, shield: 2 },
  adamantine: { helmet: 3, chestplate: 4, leggings: 3, boots: 2, gloves: 2, shield: 3 },
  dragonScale: { helmet: 3, chestplate: 4, leggings: 3, boots: 2, gloves: 2, shield: 3 }
};
const qualityModifiers = {
  common: 0,
  uncommon: 1,
  rare: 2,
  epic: 3,
  legendary: 4,
  artifact: 5
};
function updateAC() {
  const dexValue = parseInt(document.getElementById('dex').value) || 10;
  const dexMod = Math.floor((dexValue - 10) / 2);
  let totalAC = 10 + dexMod;
  let hasArmor = false;
  inventory.forEach(item => {
    if (item.type === 'armor' && item.equipped) {
      const baseAC = armorBaseAC[item.subType] || 0;
      const materialBonus = materialModifiers[item.material][item.subType] || 0;
      const qualityBonus = qualityModifiers[item.quality] || 0;
      const extraBonus = parseInt(item.acBonus) || 0;
      totalAC += baseAC + materialBonus + qualityBonus + extraBonus;
      hasArmor = true;
    }
  });
  if (!hasArmor) {
    totalAC = 10 + dexMod;
  }
  document.getElementById('ac').value = totalAC;
  saveToLocalStorage();
}

function updateArmorMaterialOptions() {
  const subType = document.getElementById('armorSubType').value;
  const materialSelect = document.getElementById('armorMaterial');
  materialSelect.innerHTML = '';
  const validMaterials = {
    leather: ['helmet', 'chestplate', 'leggings', 'boots', 'gloves'],
    studdedLeather: ['helmet', 'chestplate', 'leggings', 'boots', 'gloves'],
    steel: ['helmet', 'chestplate', 'leggings', 'boots', 'gloves', 'shield'],
    mithral: ['helmet', 'chestplate', 'leggings', 'boots', 'gloves', 'shield'],
    adamantine: ['helmet', 'chestplate', 'leggings', 'boots', 'gloves', 'shield'],
    dragonScale: ['helmet', 'chestplate', 'leggings', 'boots', 'gloves', 'shield']
  };
  ['leather', 'studdedLeather', 'steel', 'mithral', 'adamantine', 'dragonScale'].forEach(material => {
    if (validMaterials[material].includes(subType)) {
      const option = document.createElement('option');
      option.value = material;
            option.text = material.charAt(0).toUpperCase() + material.slice(1).replace(/([A-Z])/g, ' $1');
      materialSelect.appendChild(option);
    }
  });
  saveToLocalStorage(); // Сохранение изменений в localStorage
}

// Обновление категорий оружия в зависимости от подтипа
function updateWeaponCategory() {
  const subType = document.getElementById('weaponSubType').value;
  const categorySelect = document.getElementById('weaponCategory');
  categorySelect.innerHTML = '';
  const weaponCategories = {
    dagger: ['melee'],
    shortsword: ['melee'],
    longsword: ['melee'],
    greatsword: ['melee'],
    bow: ['ranged'],
    crossbow: ['ranged'],
    staff: ['magic', 'melee'],
    mace: ['melee'],
    axe: ['melee'],
    spear: ['melee', 'ranged']
  };
  (weaponCategories[subType] || ['melee']).forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.text = category.charAt(0).toUpperCase() + category.slice(1);
    categorySelect.appendChild(option);
  });
  saveToLocalStorage(); // Сохранение изменений в localStorage
}

// Обновление формы инвентаря в зависимости от типа предмета
function updateInventoryForm() {
  const type = document.getElementById('itemType').value;
  document.querySelectorAll('.dynamic-field').forEach(field => field.classList.remove('active'));
  document.querySelectorAll('#weaponSubType, #weaponCategory, #armorSubType, #armorMaterial, #itemQuality, #foodSubType, #accessorySubType, #magicEffect, #acBonus, #energy, #quantity').forEach(el => el.classList.remove('active'));

  if (type === 'weapon') {
    ['weaponSubTypeField', 'weaponCategoryField', 'itemQualityField'].forEach(id => document.getElementById(id).classList.add('active'));
    document.getElementById('weaponSubType').classList.add('active');
    document.getElementById('weaponCategory').classList.add('active');
    document.getElementById('itemQuality').classList.add('active');
    updateWeaponCategory();
  } else if (type === 'armor') {
    ['armorSubTypeField', 'armorMaterialField', 'itemQualityField', 'acBonusField'].forEach(id => document.getElementById(id).classList.add('active'));
    document.getElementById('armorSubType').classList.add('active');
    document.getElementById('armorMaterial').classList.add('active');
    document.getElementById('itemQuality').classList.add('active');
    document.getElementById('acBonus').classList.add('active');
    updateArmorMaterialOptions();
  } else if (type === 'food') {
    ['foodSubTypeField', 'energyField', 'quantityField', 'itemQualityField'].forEach(id => document.getElementById(id).classList.add('active'));
    document.getElementById('foodSubType').classList.add('active');
    document.getElementById('energy').classList.add('active');
    document.getElementById('quantity').classList.add('active');
    document.getElementById('itemQuality').classList.add('active');
  } else if (type === 'accessory') {
    ['accessorySubTypeField', 'magicEffectField', 'itemQualityField'].forEach(id => document.getElementById(id).classList.add('active'));
    document.getElementById('accessorySubType').classList.add('active');
    document.getElementById('magicEffect').classList.add('active');
    document.getElementById('itemQuality').classList.add('active');
  } else if (type === 'material' || type === 'misc') {
    ['itemQualityField'].forEach(id => document.getElementById(id).classList.add('active'));
    document.getElementById('itemQuality').classList.add('active');
  }
  saveToLocalStorage(); // Сохранение изменений в localStorage
}

// Добавление и управление инвентарём
let inventory = [];
let editingIndex = null;
document.getElementById('addItemBtn').addEventListener('click', () => {
  const name = document.getElementById('itemName').value.trim();
  const type = document.getElementById('itemType').value;
  if (!name) {
    alert('Введите название предмета!');
    return;
  }

  let item = { name, type, equipped: false };
  if (type === 'weapon') {
    const subType = document.getElementById('weaponSubType').value;
    const category = document.getElementById('weaponCategory').value;
    const quality = document.getElementById('itemQuality').value;
    if (!subType || !category || !quality) {
      alert('Заполните все поля для оружия!');
      return;
    }
    item.subType = subType;
    item.category = category;
    item.quality = quality;
  } else if (type === 'armor') {
    const subType = document.getElementById('armorSubType').value;
    const material = document.getElementById('armorMaterial').value;
    const quality = document.getElementById('itemQuality').value;
    const acBonus = parseInt(document.getElementById('acBonus').value) || 0;
    if (!subType || !material || !quality) {
      alert('Заполните все поля для брони!');
      return;
    }
    item.subType = subType;
    item.material = material;
    item.quality = quality;
    item.acBonus = acBonus;
  } else if (type === 'food') {
    const subType = document.getElementById('foodSubType').value;
    const energy = parseInt(document.getElementById('energy').value) || 0;
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    if (!subType || !energy || !quantity) {
      alert('Заполните все поля для продовольствия!');
      return;
    }
    item.subType = subType;
    item.energy = energy;
    item.quantity = quantity;
  } else if (type === 'accessory') {
    const subType = document.getElementById('accessorySubType').value;
    const quality = document.getElementById('itemQuality').value;
    const magicEffect = document.getElementById('magicEffect').value;
    if (!subType || !quality || !magicEffect) {
      alert('Заполните все поля для аксессуара!');
      return;
    }
    item.subType = subType;
    item.quality = quality;
    item.magicEffect = magicEffect;
  } else if (type === 'material' || type === 'misc') {
    const quality = document.getElementById('itemQuality').value;
    if (!quality) {
      alert('Укажите качество предмета!');
      return;
    }
    item.quality = quality;
  }
  const desc = document.getElementById('itemDesc').value.trim();
  if (desc) item.desc = desc;

  if (editingIndex !== null) {
    inventory[editingIndex] = item;
    editingIndex = null;
    document.getElementById('addItemBtn').textContent = 'Добавить предмет';
  } else {
    inventory.push(item);
  }
  resetInventoryForm();
  renderInventory();
  updateAC();
  saveToLocalStorage();
});

function resetInventoryForm() {
  document.getElementById('itemName').value = '';
  document.getElementById('itemType').value = 'weapon';
  document.querySelectorAll('.dynamic-field').forEach(field => field.classList.remove('active'));
  document.querySelectorAll('#weaponSubType, #weaponCategory, #armorSubType, #armorMaterial, #itemQuality, #foodSubType, #accessorySubType, #magicEffect, #acBonus, #energy, #quantity').forEach(el => el.classList.remove('active'));
  document.getElementById('itemDesc').value = '';
  updateInventoryForm();
  updateWeaponCategory();
  updateArmorMaterialOptions();
}

function renderInventory() {
  const tabs = ['weapon', 'armor', 'material', 'misc', 'equipped'];
  tabs.forEach(tab => {
    const container = document.getElementById(`inventory${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
    container.innerHTML = '';
    const filteredItems = inventory.filter(item => {
      if (tab === 'equipped') return item.equipped;
      return item.type === tab && !item.equipped;
    });
    filteredItems.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'inventory-item';
      div.innerHTML = `
        <span>${item.name} <span class="quality quality-${item.quality || 'common'}">${item.quality || 'Обычное'}</span></span>
        ${item.equipped ? '<input type="checkbox" checked onchange="toggleEquip(${index})"> Экипировано' : '<input type="checkbox" onchange="toggleEquip(${index})"> Экипировать'}
        <button onclick="editItem(${index})">Редактировать</button>
        <button onclick="deleteItem(${index})">Удалить</button>
      `;
      if (item.subType) div.innerHTML += `<span>(${item.subType})</span>`;
      if (item.category) div.innerHTML += `<span>(${item.category})</span>`;
      if (item.material) div.innerHTML += `<span>(${item.material})</span>`;
      if (item.energy) div.innerHTML += `<span>(+${item.energy} HP)</span>`;
      if (item.quantity) div.innerHTML += `<span>(x${item.quantity})</span>`;
      if (item.magicEffect) div.innerHTML += `<span>(${item.magicEffect})</span>`;
      if (item.desc) div.innerHTML += `<span>(${item.desc})</span>`;
      container.appendChild(div);
    });
  });
}

function toggleEquip(index) {
  inventory[index].equipped = !inventory[index].equipped;
  renderInventory();
  updateAC();
  saveToLocalStorage();
}

function editItem(index) {
  const item = inventory[index];
  document.getElementById('itemName').value = item.name;
  document.getElementById('itemType').value = item.type;
  updateInventoryForm();
  if (item.type === 'weapon') {
    document.getElementById('weaponSubType').value = item.subType || '';
    document.getElementById('weaponCategory').value = item.category || '';
    document.getElementById('itemQuality').value = item.quality || 'common';
  } else if (item.type === 'armor') {
    document.getElementById('armorSubType').value = item.subType || '';
    document.getElementById('armorMaterial').value = item.material || '';
    document.getElementById('itemQuality').value = item.quality || 'common';
    document.getElementById('acBonus').value = item.acBonus || 0;
  } else if (item.type === 'food') {
    document.getElementById('foodSubType').value = item.subType || '';
    document.getElementById('energy').value = item.energy || 0;
    document.getElementById('quantity').value = item.quantity || 0;
  } else if (item.type === 'accessory') {
    document.getElementById('accessorySubType').value = item.subType || '';
    document.getElementById('itemQuality').value = item.quality || 'common';
    document.getElementById('magicEffect').value = item.magicEffect || '';
  } else if (item.type === 'material' || item.type === 'misc') {
    document.getElementById('itemQuality').value = item.quality || 'common';
  }
  document.getElementById('itemDesc').value = item.desc || '';
  editingIndex = index;
  document.getElementById('addItemBtn').textContent = 'Сохранить изменения';
}

function deleteItem(index) {
  if (confirm('Удалить предмет?')) {
    inventory.splice(index, 1);
    renderInventory();
    updateAC();
    saveToLocalStorage();
  }
}

// Заклинания
let spells = [];
document.getElementById('addSpellBtn').addEventListener('click', () => {
  const name = document.getElementById('spellName').value.trim();
  const level = document.getElementById('spellLevel').value;
  const castingTime = document.getElementById('spellCastingTime').value.trim();
  const range = document.getElementById('spellRange').value.trim();
  const desc = document.getElementById('spellDesc').value.trim();
  if (!name || !level) {
    alert('Введите название и уровень заклинания!');
    return;
  }
  spells.push({ name, level, castingTime, range, desc });
  resetSpellForm();
  renderSpells();
  saveToLocalStorage();
});

function resetSpellForm() {
  document.getElementById('spellName').value = '';
  document.getElementById('spellLevel').value = '0';
  document.getElementById('spellCastingTime').value = '';
  document.getElementById('spellRange').value = '';
  document.getElementById('spellDesc').value = '';
}

function renderSpells() {
  const container = document.getElementById('spellList');
  container.innerHTML = '';
  spells.forEach((spell, index) => {
    const div = document.createElement('div');
    div.className = 'spell-item';
    div.innerHTML = `
      <span>${spell.name} (Уровень ${spell.level})</span>
      <button onclick="deleteSpell(${index})">Удалить</button>
    `;
    if (spell.castingTime) div.innerHTML += `<span>(${spell.castingTime})</span>`;
    if (spell.range) div.innerHTML += `<span>(${spell.range})</span>`;
    if (spell.desc) div.innerHTML += `<span>(${spell.desc})</span>`;
    container.appendChild(div);
  });
}

function deleteSpell(index) {
  if (confirm('Удалить заклинание?')) {
    spells.splice(index, 1);
    renderSpells();
    saveToLocalStorage();
  }
}

// Заметки
let notes = [];
document.getElementById('addNoteBtn').addEventListener('click', () => {
  const title = document.getElementById('noteTitle').value.trim();
  const content = document.getElementById('noteContent').value.trim();
  if (!title || !content) {
    alert('Введите заголовок и содержание заметки!');
    return;
  }
  notes.push({ title, content });
  resetNoteForm();
  renderNotes();
  saveToLocalStorage();
});

function resetNoteForm() {
  document.getElementById('noteTitle').value = '';
  document.getElementById('noteContent').value = '';
}

function renderNotes() {
  const container = document.getElementById('notesList');
  container.innerHTML = '';
  notes.forEach((note, index) => {
    const div = document.createElement('div');
    div.className = 'note-item';
    div.innerHTML = `
      <span>${note.title}</span>
      <button onclick="deleteNote(${index})">Удалить</button>
    `;
    if (note.content) div.innerHTML += `<span>(${note.content})</span>`;
    container.appendChild(div);
  });
}

function deleteNote(index) {
  if (confirm('Удалить заметку?')) {
    notes.splice(index, 1);
    renderNotes();
    saveToLocalStorage();
  }
}

// Аватар
let avatarData = '';
document.getElementById('avatarInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      avatarData = ev.target.result;
      document.getElementById('avatarPreview').style.backgroundImage = `url(${avatarData})`;
      saveToLocalStorage();
    };
    reader.readAsDataURL(file);
  }
});

// Навыки
function updateSkills() {
  const profBonus = parseInt(document.getElementById('profBonus').value) || 2;
  const skills = {
    athletics: { stat: 'str', id: 'athleticsProf', bonusId: 'athleticsBonus' },
    acrobatics: { stat: 'dex', id: 'acrobaticsProf', bonusId: 'acrobaticsBonus' },
    sleightOfHand: { stat: 'dex', id: 'sleightOfHandProf', bonusId: 'sleightOfHandBonus' },
    stealth: { stat: 'dex', id: 'stealthProf', bonusId: 'stealthBonus' },
    arcana: { stat: 'int', id: 'arcanaProf', bonusId: 'arcanaBonus' },
    history: { stat: 'int', id: 'historyProf', bonusId: 'historyBonus' },
    investigation: { stat: 'int', id: 'investigationProf', bonusId: 'investigationBonus' },
    nature: { stat: 'int', id: 'natureProf', bonusId: 'natureBonus' },
    religion: { stat: 'int', id: 'religionProf', bonusId: 'religionBonus' },
    animalHandling: { stat: 'wis', id: 'animalHandlingProf', bonusId: 'animalHandlingBonus' },
    insight: { stat: 'wis', id: 'insightProf', bonusId: 'insightBonus' },
    medicine: { stat: 'wis', id: 'medicineProf', bonusId: 'medicineBonus' },
    perception: { stat: 'wis', id: 'perceptionProf', bonusId: 'perceptionBonus' },
    survival: { stat: 'wis', id: 'survivalProf', bonusId: 'survivalBonus' },
    deception: { stat: 'cha', id: 'deceptionProf', bonusId: 'deceptionBonus' },
    intimidation: { stat: 'cha', id: 'intimidationProf', bonusId: 'intimidationBonus' },
    performance: { stat: 'cha', id: 'performanceProf', bonusId: 'performanceBonus' },
    persuasion: { stat: 'cha', id: 'persuasionProf', bonusId: 'persuasionBonus' }
  };
  for (let skill in skills) {
    const statMod = parseInt(document.getElementById(`${skills[skill].stat}Mod`).textContent.split('+')[1]) || 0;
    const isProficient = document.getElementById(skills[skill].id).checked;
    const bonus = statMod + (isProficient ? profBonus : 0);
    document.getElementById(skills[skill].bonusId).textContent = `+${bonus}`;
  }
  saveToLocalStorage();
}

// Броски кубиков
document.querySelectorAll('.dice-button').forEach(button => {
  button.addEventListener('click', () => {
    const dice = parseInt(button.getAttribute('data-dice'), 10) || 6;
    const abilityEl = document.getElementById('diceAbility');
    const ability = abilityEl ? abilityEl.value : 'none';
    let modifier = 0;

    if (ability !== 'none') {
      const modEl = document.getElementById(`${ability}Mod`) || document.getElementById(`${ability}Bonus`);
      if (modEl && typeof modEl.textContent === 'string') {
        const m = modEl.textContent.match(/-?\d+/);
        modifier = m ? parseInt(m[0], 10) : 0;
      } else {
        modifier = 0;
      }
    }

    // Генерация броска — crypto.getRandomValues если доступен, иначе Math.random
    let roll;
    if (window.crypto && window.crypto.getRandomValues) {
      const r = new Uint32Array(1);
      window.crypto.getRandomValues(r);
      roll = (r[0] % dice) + 1;
    } else {
      roll = Math.floor(Math.random() * dice) + 1;
    }

    const total = roll + modifier;
    const resEl = document.getElementById('diceResult');
    if (resEl) {
      resEl.textContent = `Результат: ${roll} + ${modifier} = ${total}\n(Кубик: D${dice}, модификатор: ${ability !== 'none' ? ability : 'нет'})`;
    }
  });
});

// Сохранение и загрузка
function saveToLocalStorage() {
  const data = {
    charName: document.getElementById('charName').textContent,
    charRace: document.getElementById('charRace').textContent,
    charClass: document.getElementById('charClass').textContent,
    charLevel: document.getElementById('charLevel').textContent,
    currentHP: document.getElementById('currentHP').value,
    maxHP: document.getElementById('maxHP').value,
    ac: document.getElementById('ac').value,
    profBonus: document.getElementById('profBonus').value,
    xpCurrent: document.getElementById('xpCurrent').value,
    xpNext: document.getElementById('xpNext').value,
    str: document.getElementById('str').value,
    dex: document.getElementById('dex').value,
    con: document.getElementById('con').value,
    int: document.getElementById('int').value,
    wis: document.getElementById('wis').value,
    cha: document.getElementById('cha').value,
    skills: Array.from(document.querySelectorAll('.skill-item input[type="checkbox"]')).map(cb => cb.checked),
    spellSlots: Array.from(document.querySelectorAll('.spell-slot-item input')).map(input => input.value),
    inventory,
    spells,
    notes,
    generalNotes: document.getElementById('generalNotes').value,
    avatarData
  };
  localStorage.setItem('dndData', JSON.stringify(data));
  console.log('Данные сохранены в localStorage');
}

function loadFromLocalStorage() {
  const data = JSON.parse(localStorage.getItem('dndData') || '{}');
  if (data.charName) document.getElementById('charName').textContent = data.charName;
  if (data.charRace) document.getElementById('charRace').textContent = data.charRace;
  if (data.charClass) document.getElementById('charClass').textContent = data.charClass;
  if (data.charLevel) document.getElementById('charLevel').textContent = data.charLevel;
  if (data.currentHP) document.getElementById('currentHP').value = data.currentHP;
  if (data.maxHP) document.getElementById('maxHP').value = data.maxHP;
  if (data.ac) document.getElementById('ac').value = data.ac;
  if (data.profBonus) document.getElementById('profBonus').value = data.profBonus;
  if (data.xpCurrent) document.getElementById('xpCurrent').value = data.xpCurrent;
  if (data.xpNext) document.getElementById('xpNext').value = data.xpNext;
  if (data.str) document.getElementById('str').value = data.str;
  if (data.dex) document.getElementById('dex').value = data.dex;
  if (data.con) document.getElementById('con').value = data.con;
  if (data.int) document.getElementById('int').value = data.int;
  if (data.wis) document.getElementById('wis').value = data.wis;
  if (data.cha) document.getElementById('cha').value = data.cha;
  if (data.skills) {
    const checkboxes = document.querySelectorAll('.skill-item input[type="checkbox"]');
    data.skills.forEach((checked, i) => checkboxes[i].checked = checked);
  }
  if (data.spellSlots) {
    const inputs = document.querySelectorAll('.spell-slot-item input');
    data.spellSlots.forEach((value, i) => inputs[i].value = value);
  }
  if (data.inventory) {
    inventory = data.inventory;
    renderInventory();
  }
  if (data.spells) {
    spells = data.spells;
    renderSpells();
  }
  if (data.notes) {
    notes = data.notes;
    renderNotes();
  }
  if (data.generalNotes) document.getElementById('generalNotes').value = data.generalNotes;
  if (data.avatarData) {
    avatarData = data.avatarData;
    document.getElementById('avatarPreview').style.backgroundImage = `url(${avatarData})`;
  }
  updateModifier('str');
  updateModifier('dex');
  updateModifier('con');
  updateModifier('int');
  updateModifier('wis');
  updateModifier('cha');
  updateSkills();
  updateAC();
  updateXP();
  initializeTabs(); // Убеждаемся, что вкладки инициализируются после загрузки
  console.log('Данные загружены из localStorage');
}

function clearLocalStorage() {
  if (confirm('Сбросить все данные?')) {
    localStorage.removeItem('dndData');
    location.reload();
  }
}

document.getElementById('exportBtn').addEventListener('click', () => {
  const data = JSON.parse(localStorage.getItem('dndData') || '{}');
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dnd_data.json';
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('importBtn').addEventListener('click', () => {
  document.getElementById('importInput').click();
});

document.getElementById('importInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const data = JSON.parse(ev.target.result);
        localStorage.setItem('dndData', JSON.stringify(data));
        loadFromLocalStorage();
        alert('Данные успешно импортированы!');
      } catch (error) {
        alert('Ошибка импорта данных!');
        console.error(error);
      }
    };
    reader.readAsText(file);
  }
});

// Привязка обработчиков к contenteditable
document.getElementById('charName').setAttribute('onkeydown', 'preventEnter(event)');
document.getElementById('charRace').setAttribute('onkeydown', 'preventEnter(event)');
document.getElementById('charClass').setAttribute('onkeydown', 'preventEnter(event)');
document.getElementById('charLevel').setAttribute('onkeydown', 'handleLevelInput(event)');
</script>
</body>
</html>
